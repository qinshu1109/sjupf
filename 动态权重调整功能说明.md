# 动态权重调整功能说明

## 🎯 功能概述

为 score_select.py 添加了智能权重重分配机制，使评分系统能够处理只有部分时间周期数据的文件，并自动调整权重分配，大大提升了系统的灵活性和适用性。

## 📊 支持的数据场景

| 场景 | 7天字段状态 | 30天字段状态 | 权重调整策略 | 实际应用 |
|------|-------------|--------------|--------------|----------|
| **A. 完整数据** | ✅ 存在 | ✅ 存在 | 使用默认权重配置 | 标准电商数据 |
| **B. 仅30天数据** | ❌ 缺失 | ✅ 存在 | 将7天权重按比例转移给30天字段 | 月度报表数据 |
| **C. 仅7天数据** | ✅ 存在 | ❌ 缺失 | 将30天权重按比例转移给7天字段 | 周度快报数据 |
| **D. 无销量数据** | ❌ 缺失 | ❌ 缺失 | 抛出错误，跳过该文件 | 无效数据文件 |

## 🔧 技术实现详情

### 1. 基础权重配置优化

```python
def get_base_weights():
    """获取基础权重配置（支持动态调整）"""
    return {
        'sales_30d_score': 0.12,    # 30天销量权重
        'gmv_30d_score': 0.08,      # 30天GMV权重
        'sales_7d_score': 0.08,     # 7天销量权重
        'gmv_7d_score': 0.07,       # 7天GMV权重
        'commission_score': 0.15,    # 佣金权重
        'influencer_score': 0.10,    # 达人影响力权重
        'rank_score': 0.12,          # 排名权重
        'growth_score': 0.08,        # 增长潜力权重
        'channel_score': 0.05,       # 渠道分布权重
        'conv_score': 0.05,          # 转化率权重
        'live_gmv_score': 0.05,      # 直播GMV权重
        'card_gmv_score': 0.05       # 商品卡GMV权重
    }
```

### 2. 动态权重调整算法

#### 场景B: 仅30天数据
```python
# 将7天权重转移给30天字段
boost_total = weights['sales_7d_score'] + weights['gmv_7d_score']  # 0.08 + 0.07 = 0.15
current_30d_total = weights['sales_30d_score'] + weights['gmv_30d_score']  # 0.12 + 0.08 = 0.20

# 按比例分配增加的权重
sales_boost = 0.15 × (0.12 / 0.20) = 0.09
gmv_boost = 0.15 × (0.08 / 0.20) = 0.06

# 最终权重
sales_30d_score: 0.12 + 0.09 = 0.21
gmv_30d_score: 0.08 + 0.06 = 0.14
```

#### 场景C: 仅7天数据
```python
# 将30天权重转移给7天字段
boost_total = weights['sales_30d_score'] + weights['gmv_30d_score']  # 0.12 + 0.08 = 0.20
current_7d_total = weights['sales_7d_score'] + weights['gmv_7d_score']  # 0.08 + 0.07 = 0.15

# 按比例分配增加的权重
sales_boost = 0.20 × (0.08 / 0.15) = 0.107
gmv_boost = 0.20 × (0.07 / 0.15) = 0.093

# 最终权重
sales_7d_score: 0.08 + 0.107 = 0.187
gmv_7d_score: 0.07 + 0.093 = 0.163
```

### 3. 节日模式兼容性

动态权重调整与节日模式完美结合：

```python
# 处理顺序
1. 字段动态调整 → adjust_weights_for_available_fields()
2. 节日模式调整 → adjust_holiday_weights()

# 节日模式智能选择
if adjusted_weights['sales_7d_score'] > 0:
    # 优先调整7天销量权重 +0.02
    adjusted['sales_7d_score'] += 0.02
elif adjusted_weights['sales_30d_score'] > 0:
    # 如果没有7天数据，调整30天销量权重 +0.02
    adjusted['sales_30d_score'] += 0.02
```

## 🧪 测试验证结果

### 权重调整验证

| 场景 | sales_7d | sales_30d | gmv_7d | gmv_30d | 权重总和 |
|------|----------|-----------|--------|---------|----------|
| **完整数据** | 0.080 | 0.120 | 0.070 | 0.080 | 1.000000 ✅ |
| **仅30天** | 0.000 | 0.210 | 0.000 | 0.140 | 1.000000 ✅ |
| **仅7天** | 0.187 | 0.000 | 0.163 | 0.000 | 1.000000 ✅ |

### 评分结果对比

| 场景 | 平均总分 | 最高总分 | 说明 |
|------|----------|----------|------|
| **完整数据** | 0.4846 | 0.7028 | 基准评分 |
| **仅30天数据** | 0.5073 | 0.7256 | 30天权重增强后评分略高 |
| **仅7天数据** | 0.5093 | 0.7316 | 7天权重增强后评分最高 |

### 节日模式结合测试

| 场景 | 字段调整后 | 节日调整后 | 权重变化 |
|------|------------|------------|----------|
| **完整数据** | sales_7d: 0.080 | sales_7d: 0.100 | +0.020 ✅ |
| **仅30天** | sales_30d: 0.210 | sales_30d: 0.230 | +0.020 ✅ |
| **仅7天** | sales_7d: 0.187 | sales_7d: 0.207 | +0.020 ✅ |

## 📁 测试数据文件

已创建三个测试文件供Web界面验证：

1. **scenario_A_完整数据.csv** - 包含所有7天和30天字段
2. **scenario_B_仅30天数据.csv** - 仅包含30天相关字段
3. **scenario_C_仅7天数据.csv** - 仅包含7天相关字段

## 🚀 使用方法

### Web界面测试
1. 访问评分系统: http://localhost:8510
2. 上传测试文件（可同时上传多个不同场景的文件）
3. 启用/关闭节日加权模式
4. 点击"开始评分"观察权重调整过程
5. 查看TOP50结果

### 命令行测试
```bash
# 测试动态权重功能
python3 test_dynamic_weights.py

# 使用CLI处理不同场景文件
python3 score_select.py --in test_csv --out results
```

## 💡 业务价值

### 1. 数据兼容性提升
- **支持不完整数据**：不再要求数据文件包含所有时间周期字段
- **灵活数据源**：可处理来自不同系统的数据文件
- **降低数据准备成本**：减少数据预处理工作量

### 2. 评分准确性保证
- **权重科学分配**：确保评分权重总和始终为1.0
- **比例合理调整**：按原有权重比例进行转移
- **业务逻辑一致**：保持评分体系的业务合理性

### 3. 系统鲁棒性增强
- **错误处理完善**：无效数据文件自动跳过
- **日志信息详细**：权重调整过程透明可见
- **向后兼容**：完整数据文件使用原有逻辑

## 🔧 技术特性

### 1. 智能检测
- 自动检测数据文件中的字段完整性
- 智能识别7天和30天数据的存在性
- 动态选择最适合的权重调整策略

### 2. 精确计算
- 数学精确的权重重分配算法
- 保证权重总和恒等于1.0
- 按比例进行权重转移

### 3. 完美集成
- 与现有评分算法无缝集成
- 与节日模式完美结合
- 与Web界面自动兼容

## 📊 实际应用场景

### 1. 多数据源整合
- **周报数据**：仅包含7天字段的快速报表
- **月报数据**：仅包含30天字段的详细分析
- **混合数据**：不同来源的数据文件批量处理

### 2. 数据迁移过渡
- **系统升级**：新旧系统数据格式不一致时的过渡处理
- **数据补全**：历史数据缺失字段的智能处理
- **格式标准化**：统一不同格式的数据文件

### 3. 业务场景适配
- **紧急分析**：使用不完整数据进行快速评分
- **实时监控**：处理实时数据流中的不完整记录
- **A/B测试**：对比不同数据完整度下的评分效果

---

**功能已完全实现并通过测试，可立即投入使用！** 🎉
